{% extends "main.html" %}

{% block title %}Coinflip - AH Gambling{% endblock %}

{% block content %}
<style>
*{box-sizing:border-box;}
body{margin:0;font-family:Arial,sans-serif;background:#0b0b0b;color:#fff;}

.coinflip-page{max-width:1200px;margin:40px auto;display:flex;flex-direction:column;gap:24px;align-items:center;}
.coinflip-controls{display:flex;flex-direction:column;gap:16px;align-items:center;}
.stats-cards{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;}

.stat-card{background:#1e1e2e;border:1px solid #333;border-radius:12px;padding:16px;text-align:center;min-width:100px;}
.stat-value{font-size:1.2rem;font-weight:600;color:#22c55e;}
.stat-title{font-size:.85rem;color:#9ca3af;margin-bottom:6px;}

.create-btn{padding:14px 30px;background:#2563eb;border:none;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer;}
.create-btn:hover{background:#1d4ed8;}

.coinflip-container{width:100%;max-height:900px;overflow-y:auto;display:flex;flex-direction:column;gap:16px;padding:0 8px;}

.match-card{background:#1e1e2e;border:1px solid #333;border-radius:12px;padding:16px;display:flex;flex-direction:column;gap:12px;}
.players{display:flex;align-items:center;gap:16px;justify-content:center;}
.player{position:relative;display:flex;flex-direction:column;align-items:center;}

.player-avatar{width:80px;height:80px;border-radius:50%;object-fit:cover;border:2px solid #333;background:#111;}
.vs-text{font-weight:700;font-size:1.2rem;}

.side-badge{position:absolute;top:-5px;left:-5px;background:#2a2a3d;border:1px solid #444;border-radius:50%;width:28px;height:28px;display:flex;align-items:center;justify-content:center;font-size:.9rem;}

.items-preview{display:flex;gap:6px;justify-content:center;}
.preview-item{width:40px;height:40px;border-radius:6px;background:#222;border:1px solid #333;display:flex;align-items:center;justify-content:center;}
.preview-item img{width:100%;height:100%;object-fit:cover;}

.match-actions{display:flex;gap:8px;justify-content:center;}
.match-btn{padding:8px 16px;border:none;border-radius:6px;cursor:pointer;font-weight:600;}
.join-btn{background:#16a34a;color:#fff;}
.view-btn{background:#2563eb;color:#fff;}

.modal{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:9999;}
.modal.open{display:flex;}

.wallet{background:#1c2433;border-radius:14px;width:100%;max-width:450px;padding:24px;max-height:90vh;overflow-y:auto;}
.wallet-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
.close{cursor:pointer;font-size:1.5rem;}

.inventory-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(85px,1fr));gap:10px;max-height:250px;overflow-y:auto;margin-top:12px;background:#0f172a;padding:10px;border-radius:8px;border:1px solid #333;}

.inventory-item{background:#1e293b;border-radius:6px;padding:8px;text-align:center;cursor:pointer;border:2px solid transparent;}
.inventory-item.selected{border-color:#16a34a;background:#064e3b;}

.coinflip-side-select{display:flex;gap:12px;margin-bottom:14px;}
.side-option{flex:1;padding:12px;text-align:center;border-radius:10px;cursor:pointer;background:#111;border:1px solid #333;}
.side-option.selected{background:#16a34a;border-color:#16a34a;}

.action-btn{flex:1;padding:12px;border-radius:8px;border:none;font-weight:600;cursor:pointer;}
.deposit{background:#2563eb;color:#fff;}
.withdraw{background:#dc2626;color:#fff;}
</style>

<div class="modal" id="coinflipModal">
<div class="wallet">

<div class="wallet-header">
<h2 id="coinflipModalTitle">Coinflip</h2>
<span class="close" data-close="coinflipModal">&times;</span>
</div>

<input id="coinflipSearch" placeholder="Search items..."
style="width:100%;padding:10px;background:#111;border:1px solid #333;color:white;border-radius:8px;margin-bottom:12px;"/>

<p id="coinflipMatchIdRow" style="font-size:.85rem;margin-bottom:10px;display:none;">
Match ID: <strong id="coinflipMatchIdDisplay"></strong>
</p>

<div style="display:flex;justify-content:space-between;margin-bottom:10px;font-size:.9rem;">
<div>Total Selected: <strong id="coinflipTotalItems">0</strong></div>
<div>Value: <strong id="coinflipTotalValue">$0</strong></div>
</div>

<div id="coinflipSideSelect" class="coinflip-side-select">
<div class="side-option selected" data-side="Heads">ðŸª™ Heads</div>
<div class="side-option" data-side="Tails">ðŸ’° Tails</div>
</div>

<div class="inventory-grid" id="coinflipInventory"></div>

<div class="match-actions" style="margin-top:16px;">
<button class="action-btn withdraw" data-close="coinflipModal">Cancel</button>
<button class="action-btn deposit" id="coinflipConfirmBtn">Confirm</button>
</div>

</div>
</div>

<div class="coinflip-page">

<div class="coinflip-controls">
<div class="stats-cards">
<div class="stat-card">
<div class="stat-title">Active Coinflips</div>
<div class="stat-value">{{ matches|length }}</div>
</div>
<div class="stat-card">
<div class="stat-title">Total Items Value</div>
<div class="stat-value">${{ matches|sum(attribute='total_value') }}</div>
</div>
</div>

<button class="create-btn" id="createMatchBtn">Create Match</button>
</div>

<div class="coinflip-container">

{% for match in matches %}
<div class="match-card" data-id="{{match.id}}" data-side="{{match.side}}" data-value="{{match.total_value}}">
<div class="players">
<div class="player">
<div class="side-badge">{{"ðŸª™" if match.side=="Heads" else "ðŸ’°"}}</div>
<img class="player-avatar" src="{{match.player1.avatar}}">
</div>
<div class="vs-text">VS</div>
<div class="player">
{% if match.player2 %}
<img class="player-avatar" src="{{match.player2.avatar}}">
{% else %}
<div class="player-avatar" style="display:flex;align-items:center;justify-content:center;color:#444;">?</div>
{% endif %}
</div>
</div>

<div class="items-preview">
{% for item in match["items"][:5] %}
<div class="preview-item"><img src="{{item.image}}"></div>
{% endfor %}
</div>

<div class="match-actions">
<button class="match-btn join-btn">Join</button>
<button class="match-btn view-btn">View</button>
</div>
</div>
{% endfor %}

</div>
</div>

<script>
document.addEventListener("DOMContentLoaded",()=>{

let globalInventory=[];
let modalSelection=[];
let modalMode=null;
let requiredJoinValue=0;
let currentJoinMatchId=null;

function updateStats(){
const totalItems=modalSelection.length;
const totalValue=modalSelection.reduce((s,i)=>s+(parseFloat(i.Value)||0),0);

coinflipTotalItems.textContent=totalItems;
coinflipTotalValue.textContent=`$${totalValue.toLocaleString()}`;

if(modalMode==="join"){
coinflipConfirmBtn.disabled=Math.abs(totalValue-requiredJoinValue)>0.01;
}
}

function renderInventory(){
coinflipInventory.innerHTML="";
globalInventory.forEach(item=>{
const div=document.createElement("div");
div.className=`inventory-item ${modalSelection.some(i=>i.itemid===item.itemid)?"selected":""}`;

div.innerHTML=`
<img src="${item.ImageUrl}" style="width:40px;height:40px;object-fit:contain;">
<div style="font-size:10px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
${item.itemname}
</div>
<div class="item-val">$${item.Value}</div>
`;

div.onclick=()=>{
const idx=modalSelection.findIndex(i=>i.itemid===item.itemid);
if(idx>-1) modalSelection.splice(idx,1);
else modalSelection.push(item);
div.classList.toggle("selected");
updateStats();
};

coinflipInventory.appendChild(div);
});
}

function openCreate(){
modalMode="create";
modalSelection=[];
coinflipModalTitle.textContent="Create Coinflip";
coinflipSideSelect.style.display="flex";
coinflipMatchIdRow.style.display="none";
coinflipConfirmBtn.disabled=false;
updateStats();
renderInventory();
coinflipModal.classList.add("open");
}

function openJoin(card){
modalMode="join";
modalSelection=[];
requiredJoinValue=parseFloat(card.dataset.value||0);
currentJoinMatchId=card.dataset.id;

coinflipModalTitle.textContent="Join Coinflip";
coinflipSideSelect.style.display="none";
coinflipMatchIdRow.style.display="block";
coinflipMatchIdDisplay.textContent=currentJoinMatchId;

updateStats();
renderInventory();
coinflipModal.classList.add("open");
}

createMatchBtn.onclick=openCreate;

document.querySelector(".coinflip-container")
.addEventListener("click",e=>{
const card=e.target.closest(".match-card");
if(!card) return;
if(e.target.classList.contains("join-btn")) openJoin(card);
});

document.querySelectorAll("[data-close]").forEach(btn=>{
btn.onclick=()=>coinflipModal.classList.remove("open");
});

async function fetchInventory(){
try{
const res=await fetch("/GetInventory");
globalInventory=await res.json();
}catch{
globalInventory=[];
}
}
fetchInventory();

});
</script>

{% endblock %}
