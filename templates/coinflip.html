{% extends "main.html" %}

{% block title %}Coinflip - AH Gambling{% endblock %}

{% block content %}
<style>
    * { box-sizing: border-box; }

    body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #0b0b0b;
        color: #fff;
    }

      html, body {
          overflow-x: hidden;
          width: 100%;
          position: relative;
      }
      
      .coinflip-page {
          width: 100%;
          max-width: 1200px;
          margin: 40px auto;
          padding: 0 20px; 
          overflow-x: hidden; 
      }


    .coinflip-controls {
        display: flex;
        flex-direction: column;
        gap: 16px;
        align-items: center;
    }

    .stats-cards {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        justify-content: center;
    }

    .stat-card {
        background: #1e1e2e;
        border: 1px solid #333;
        border-radius: 12px;
        padding: 16px;
        text-align: center;
        min-width: 120px;
    }

    .stat-value {
        font-size: 1.2rem;
        font-weight: 600;
        color: #22c55e;
    }

    .stat-title {
        font-size: 0.85rem;
        color: #9ca3af;
        margin-bottom: 6px;
    }

    .create-btn {
        padding: 14px 40px;
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
    }

    .create-btn:hover { background: #1d4ed8; }

    .coinflip-container {
        width: 100%;
        max-height: 900px; 
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 16px;
        padding: 0 8px;
    }

    .match-card {
        background: #1e1e2e;
        border: 1px solid #333;
        border-radius: 12px;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .players {
        display: flex;
        align-items: center;
        gap: 20px;
        justify-content: center;
    }

    .player {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .player-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #333;
        background: #000;
    }

    .empty-avatar-placeholder {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: #000;
        border: 2px dashed #333;
    }

    .side-badge {
        position: absolute;
        top: -5px;
        left: -5px;
        background: #2a2a3d;
        border: 1px solid #444;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
        z-index: 10;
        box-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }

    .vs-text { font-weight: 700; font-size: 1.2rem; color: #4b5563; }

    .modal {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,.85);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }

    .modal.open { display: flex; }

    .wallet {
        background: #1c2433;
        border-radius: 14px;
        width: 100%;
        max-width: 480px;
        padding: 24px;
        max-height: 90vh;
        overflow-y: auto;
        border: 1px solid #334155;
    }

    .wallet-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .close { cursor: pointer; font-size: 1.5rem; color: #94a3b8; }

    .modal-stat-bar {
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
        font-size: 0.9rem;
        background: #0f172a;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #333;
    }

    .modal-search {
        width: 100%;
        padding: 12px;
        background: #0b0b0b;
        border: 1px solid #333;
        color: white;
        border-radius: 8px;
        margin-bottom: 12px;
        outline: none;
    }

      .inventory-grid {
                display: grid !important; 
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 12px;
                margin-top: 15px;
                flex: 1;                
                overflow-y: auto;       
                min-height: 300px;     
                padding: 10px;
                background: rgba(0,0,0,0.2);
                border-radius: 8px;
            }
            
            .inventory-item {
                background: #111827 !important;
                border: 1px solid #334155;
                padding: 10px;
                min-height: 140px;     
                display: flex !important;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }
    .inventory-item.selected { border-color: #16a34a; background: #064e3b; }
    .item-val { font-size: 10px; color: #22c55e; font-weight: bold; margin-top: 4px; }

    .coinflip-side-select {
        display: flex;
        gap: 12px;
        margin-bottom: 14px;
    }

    .side-option {
        flex: 1;
        padding: 12px;
        text-align: center;
        border-radius: 10px;
        cursor: pointer;
        background: #0b0b0b;
        border: 1px solid #333;
        transition: 0.2s;
    }

    .side-option.selected {
        background: #16a34a;
        border-color: #16a34a;
        font-weight: bold;
    }

    .match-actions { display: flex; gap: 8px; justify-content: center; }
    
    .match-btn {
        padding: 8px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: opacity 0.2s;
    }

    .join-btn { background: #16a34a; color: #fff; }
    .view-btn { background: #334155; color: #fff; }

    .match-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }

    .action-btn { flex: 1; padding: 12px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; }
    .action-btn.deposit { background: #2563eb; color: #fff; }
    .action-btn.withdraw { background: #374151; color: #fff; }

    .items-preview { display: flex; gap: 6px; justify-content: center; flex-wrap: wrap; }
    .preview-item {
        width: 40px;
        height: 40px;
        border-radius: 6px;
        background: #0b0b0b;
        border: 1px solid #333;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }
    .preview-item img { width: 90%; height: 90%; object-fit: contain; }

    @media (max-width: 800px) {
        .players { gap: 10px; }
        .player-avatar, .empty-avatar-placeholder { width: 60px; height: 60px; }
    }
</style>

<div class="modal" id="createCoinflipModal">
    <div class="wallet">
        <div class="wallet-header">
            <h2>Create Coinflip</h2>
            <span class="close" data-close="createCoinflipModal">&times;</span>
        </div>
        <div class="modal-stat-bar">
            <div>Selected: <strong id="createTotalItems">0</strong></div>
            <div>Value: <strong id="createTotalValue">$0</strong></div>
        </div>
        <div class="coinflip-side-select">
            <div class="side-option selected" data-side="Heads">ðŸª™ Heads</div>
            <div class="side-option" data-side="Tails">ðŸ’° Tails</div>
        </div>
        <input id="createSearch" class="modal-search" placeholder="Search items..." />
        <div class="inventory-grid" id="createInventory"></div>
        <div class="match-actions" style="margin-top:20px;">
            <button class="action-btn withdraw" data-close="createCoinflipModal">Cancel</button>
            <button class="action-btn deposit" id="coinflipCreateBtn">Create Match</button>
        </div>
    </div>
</div>

<div class="modal" id="joinCoinflipModal">
    <div class="wallet">
        <div class="wallet-header">
            <h2>Join Coinflip</h2>
            <span class="close" data-close="joinCoinflipModal">&times;</span>
        </div>
        <div class="modal-stat-bar">
            <div>Selected: <strong id="joinTotalItems">0</strong></div>
            <div>Value: <strong id="joinTotalValue">$0</strong></div>
        </div>
        <input id="joinSearch" class="modal-search" placeholder="Search items..." />
        <div class="inventory-grid" id="joinInventory"></div>
        <div class="match-actions" style="margin-top:20px;">
            <button class="action-btn withdraw" data-close="joinCoinflipModal">Cancel</button>
            <button class="action-btn deposit" id="confirmJoinBtn">Confirm Join</button>
        </div>
    </div>
</div>

<div class="modal" id="viewCoinflipModal">
    <div class="wallet">
        <div class="wallet-header">
            <h2>Match Details</h2>
            <span class="close" data-close="viewCoinflipModal">&times;</span>
        </div>
        <div id="viewCoinflipContent"></div>
        <div id="viewModalActions" class="match-actions" style="margin-top:24px;"></div>
    </div>
</div>

<div class="coinflip-page">
    <div class="coinflip-controls">
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-title">Active Matches</div>
                <div class="stat-value">{{ matches|length }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Total Value</div>
                <div class="stat-value">${{ matches|sum(attribute='total_value')|round(2) }}</div>
            </div>
        </div>
        <button class="create-btn" id="createMatchBtn">CREATE MATCH</button>
    </div>

    <div class="coinflip-container">
        {% for match in matches %}
        <div class="match-card" data-id="{{ match.id }}" data-side="{{ match.side }}" data-total-value="{{ match.total_value|round(2) }}">
            <div class="players">
                <div class="player" data-username="{{ match.player1.username }}">
                    <div class="side-badge">{{ "ðŸª™" if match.side == "Heads" else "ðŸ’°" }}</div>
                    <img class="player-avatar" src="{{ match.player1.avatar }}">
                </div>
                
                <div class="vs-text">VS</div>
                
                <div class="player" data-username="{{ match.player2.username }}">
                    {% if match.player2.username != "" %}
                        <div class="side-badge">{{ "ðŸ’°" if match.side == "Heads" else "ðŸª™" }}</div>
                        <img class="player-avatar" src="{{ match.player2.avatar }}">
                    {% else %}
                        <div class="empty-avatar-placeholder"></div>
                    {% endif %}
                </div>
            </div>
            <div class="items-preview">
                {% for item in match["items"][:5] %}
                <div class="preview-item"><img src="{{ item.image }}"></div>
                {% endfor %}
            </div>
            <div class="match-actions">
                <button class="match-btn join-btn" {% if match.player2.username != "" %}disabled{% endif %}>Join</button>
                <button class="match-btn view-btn">View</button>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const currentUsername = "{{ username }}"; 

    let globalInventory = [];
    let createSelection = []; // Stores strings like "ItemName#Serial"
    let joinSelection = [];   // Stores strings like "ItemName#Serial"
    let activeMatchId = null;

    // Helper to find item object by formatted ID
    const getItemFromId = (formattedId) => {
        const [name, serial] = formattedId.split('#');
        return globalInventory.find(i => String(i.itemname) === name && String(i.serial) === serial);
    };

    const updateStats = (prefix, selection) => {
        const totalItems = selection.length;
        const totalValue = selection.reduce((sum, id) => {
            const item = getItemFromId(id);
            return sum + (item ? parseFloat(item.Value) : 0);
        }, 0);
        
        document.getElementById(`${prefix}TotalItems`).textContent = totalItems;
        document.getElementById(`${prefix}TotalValue`).textContent = `$${totalValue.toFixed(2)}`;
    };

    const renderInventory = (containerId, selectionArr, prefix) => {
        const grid = document.getElementById(containerId);
        if(!grid) return;
        grid.innerHTML = '';
        globalInventory.forEach(item => {
            const itemIdentifier = `${item.itemname}#${item.serial}`;
            const div = document.createElement('div');
            div.className = `inventory-item ${selectionArr.includes(itemIdentifier) ? 'selected' : ''}`;
            div.innerHTML = `
                <img src="${item.ImageUrl}" style="width:40px;height:40px;object-fit:contain;">
                <div style="font-size:10px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${item.itemname}</div>
                <div class="item-val">$${item.Value}</div>
            `;
            
            div.onclick = () => {
                const index = selectionArr.indexOf(itemIdentifier);
                if(index > -1) selectionArr.splice(index, 1);
                else selectionArr.push(itemIdentifier);
                
                div.classList.toggle('selected');
                updateStats(prefix, selectionArr);
            };
            grid.appendChild(div);
        });
    };

    const openJoinModal = (id) => {
        activeMatchId = id;
        joinSelection = [];
        updateStats('join', joinSelection);
        renderInventory('joinInventory', joinSelection, 'join');
        document.getElementById('joinCoinflipModal').classList.add('open');
    };

    // Close Modals
    document.querySelectorAll('.close, [data-close]').forEach(btn => {
        btn.addEventListener('click', () => {
            const target = btn.getAttribute('data-close') || btn.closest('.modal').id;
            document.getElementById(target).classList.remove('open');
        });
    });

    // Create Match Button Click
    document.getElementById("createMatchBtn")?.addEventListener("click", () => {
        createSelection = [];
        updateStats('create', createSelection);
        renderInventory('createInventory', createSelection, 'create');
        document.getElementById("createCoinflipModal").classList.add("open");
    });

    // Confirm Join Button Click
    document.getElementById('confirmJoinBtn')?.addEventListener('click', async function() {
        if (joinSelection.length === 0) return alert("Please select items to join.");
        const btn = this;
        btn.disabled = true;
        btn.innerText = "Joining...";

        try {
            const response = await fetch('/JoinMatch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    matchId: activeMatchId,
                    items: joinSelection // Sends array of "ItemName#Serial"
                })
            });
            const result = await response.json();
            if (result.success) location.reload();
            else alert(result.error || "Failed to join match.");
        } catch (e) {
            alert("An error occurred.");
        } finally {
            btn.disabled = false;
            btn.innerText = "Confirm Join";
        }
    });

    // Match Card Interactions (Join/View)
    document.querySelector('.coinflip-container')?.addEventListener('click', e => {
        const matchCard = e.target.closest('.match-card');
        if (!matchCard) return;

        if (e.target.classList.contains('join-btn')) {
            if (!e.target.disabled) openJoinModal(matchCard.dataset.id);
        }

        if (e.target.classList.contains('view-btn')) {
            const matchId = matchCard.dataset.id;
            const p1Side = matchCard.dataset.side;
            const totalVal = matchCard.dataset.totalValue;
            
            const p1Node = matchCard.querySelector('.player:first-child');
            const p2Node = matchCard.querySelector('.player:last-child');
            
            const p1User = p1Node.getAttribute('data-username');
            const p2User = p2Node.getAttribute('data-username');
            
            const isCreator = (p1User === currentUsername);
            const hasJoiner = (p2User && p2User !== "");
            
            let html = `
                <div style="text-align:center; margin-bottom: 15px; color: #22c55e; font-weight: bold;">
                    Match Value: $${totalVal}
                </div>
                <div style="display:flex;justify-content:center;align-items:center;gap:25px;margin-bottom:20px;">
            `;

            [p1Node, p2Node].forEach((p, idx) => {
                const avatar = p.querySelector('.player-avatar')?.src;
                const isEmpty = p.querySelector('.empty-avatar-placeholder');
                const username = p.getAttribute('data-username') || "Waiting...";
                const sideIcon = (idx === 0) ? (p1Side === "Heads" ? "ðŸª™" : "ðŸ’°") : (p1Side === "Heads" ? "ðŸ’°" : "ðŸª™");
                
                if (isEmpty) {
                    html += `<div class="player"><div class="empty-avatar-placeholder" style="width:70px;height:70px;"></div><div style="font-size: 0.7rem; margin-top:5px; color:#666;">Waiting...</div></div>`;
                } else {
                    html += `
                        <div class="player">
                            <div class="side-badge" style="width:24px;height:24px;font-size:0.7rem;">${sideIcon}</div>
                            <img src="${avatar}" class="player-avatar" style="width:70px;height:70px;">
                            <div style="font-size: 0.75rem; margin-top: 5px; color: #94a3b8;">${username}</div>
                        </div>`;
                }
                if(idx === 0) html += `<div class="vs-text" style="font-size:1rem;">VS</div>`;
            });
            
            html += `</div><div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;border-top:1px solid #333;padding-top:20px;">`;
            matchCard.querySelectorAll('.preview-item img').forEach(img => {
                html += `<div class="preview-item" style="width:45px;height:45px;"><img src="${img.src}"></div>`;
            });
            html += `</div>`;

            document.getElementById('viewCoinflipContent').innerHTML = html;
            const actionArea = document.getElementById('viewModalActions');
            actionArea.innerHTML = `<button class="action-btn withdraw" id="viewModalCloseBtn">Close</button>`;
            
            if (isCreator && hasJoiner) {
                const acceptBtn = document.createElement('button');
                acceptBtn.className = "action-btn deposit";
                acceptBtn.innerText = "Accept Match";
                acceptBtn.onclick = () => handleAccept(matchId);
                actionArea.prepend(acceptBtn);
            } else if (!hasJoiner && !isCreator) {
                const jBtn = document.createElement('button');
                jBtn.className = "action-btn deposit";
                jBtn.innerText = "Join Match";
                jBtn.onclick = () => {
                    document.getElementById('viewCoinflipModal').classList.remove('open');
                    openJoinModal(matchId);
                };
                actionArea.prepend(jBtn);
            }

            document.getElementById('viewModalCloseBtn').onclick = () => {
                document.getElementById('viewCoinflipModal').classList.remove('open');
            };

            document.getElementById('viewCoinflipModal').classList.add('open');
        }
    });

    async function handleAccept(matchId) {
        try {
            const response = await fetch('/AcceptMatch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ matchId: matchId })
            });
            const result = await response.json();
            if (result.success) location.reload();
            else alert(result.error || "Failed to accept match.");
        } catch (e) {
            alert("An error occurred.");
        }
    }

    async function fetchInventory() {
        try {
            const res = await fetch('/GetInventory');
            globalInventory = await res.json();
        } catch (e) {
            globalInventory = [];
        }
    }
    fetchInventory();
});
</script>
{% endblock %}
